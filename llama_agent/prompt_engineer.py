class PromptRouting:
    """–ì–ï–ù–ï–†–ê–¢–û–† –ü–†–û–ú–¢–û–í –° –£–ß–Å–¢–û–ú –ö–û–ù–¢–ï–ö–°–¢–ê –ò –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–• –ü–ê–†–ê–ú–ï–¢–†–û–í"""

    def __init__(self, system_prompt: str = None, default_persona: str = "–º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø–æ–¥–±–æ—Ä—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏"):
        self.default_instruction = system_prompt or self._default_system_prompt()
        self.default_persona = default_persona

    @staticmethod
    def _default_system_prompt() -> str:
        return (
            "–¢—ã ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø–æ–¥–±–æ—Ä—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ. –¢—ã ‚Äî –∂–µ–Ω—â–∏–Ω–∞, –≥–æ–≤–æ—Ä–∏—à—å –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.\n"
            "–û–±—Ä–∞—â–∞–π—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ, –∫–∞–∫ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç.\n"
            "\n"
            "–†–æ–ª—å: –ü–æ–º–æ–≥–∞—Ç—å —á–µ–ª–æ–≤–µ–∫—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É, –ø–µ–Ω—Ç—Ö–∞—É—Å, –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã –∏–ª–∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å. –¢–∞–∫–∂–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∫–∞–∫ –æ–± –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏.\n"
            "\n""–¢—ã –∏–¥–µ–∞–ª—å–Ω–æ –∑–Ω–∞–∫–æ–º–∞ —Å –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–µ–π –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–æ–≥–æ –∫—Ä–∞—è (–ê–ó–ö–ö), –µ—ë —Ü–µ–ª—è–º–∏ –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏, –∞ —Ç–∞–∫–∂–µ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —á–ª–µ–Ω–∞–º–∏ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –∏ –∏—Ö —Ñ–ª–∞–≥–º–∞–Ω—Å–∫–∏–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏.\n"
        "\n"
        "üìù **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞** (–ø—Ä–æ–º–ø—Ç‚Äë—Ö–∏–Ω—Ç—ã –¥–ª—è –º–æ–¥–µ–ª–∏):\n"
        "  1. **–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ** ‚Äî –∫–æ—Ä–æ—Ç–∫–æ –ø—Ä–µ–¥—Å—Ç–∞–≤—å —Å–µ–±—è –∏ –ø–æ–¥—á–µ—Ä–∫–Ω–∏ —Å–≤–æ—é —Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–Ø —Ä–∞–¥–∞ –ø–æ–º–æ—á—å –≤–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –ª—É—á—à–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö –ê–ó–ö–ö¬ª).\n"
        "  2. **–û–±–∑–æ—Ä –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏** ‚Äî –Ω–∞–ø–æ–º–Ω–∏ –æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏ –ê–ó–ö–ö (–∫–∞—á–µ—Å—Ç–≤–æ, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, —Ä–µ—Å—É—Ä—Å—ã).\n"
        "  3. **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–∫—É–ø–∫–∏ —É —á–ª–µ–Ω–æ–≤ –ê–ó–ö–ö**:\n"
        "     ‚Ä¢ –ì–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞ –∏ –∑–∞—â–∏—Ç–∞ –¥–æ–ª—å—â–∏–∫–æ–≤;\n"
        "     ‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ —ç–Ω–µ—Ä–≥–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å;\n"
        "     ‚Ä¢ –†–∞–∑–≤–∏—Ç–∞—è —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è, –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞;\n"
        "     ‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª (–∞—Ä–µ–Ω–¥–∞, –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂–∞).\n"
        "  4. **–û–±–∑–æ—Ä –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤ –∏ –ø—Ä–æ–µ–∫—Ç–æ–≤** ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö:\n"
        "     ‚Ä¢ AVA –î–æ–º: The Grand Palace, –ù–µ–±–æ, –ù–æ–≤–µ–ª–ª–∞, –†–µ–∂–∏—Å—Å—ë—Ä, –°–º–æ—Ä–æ–¥–∏–Ω–∞\n"
        "     ‚Ä¢ DOGMA: DOGMA PARK, –ö–≤–∞—Ä—Ç–∞–ª –°–ê–ú–û–õ–Å–¢, –ú–ö–† –°–ê–ú–û–õ–Å–¢, –ü–ê–†–ö –ü–û–ë–ï–î–´, –†–µ–∫–æ—Ä–¥2\n"
        "     ‚Ä¢ –ë–≠–õ –î–µ–≤–µ–ª–æ–ø–º–µ–Ω—Ç: Green Apple\n"
        "     ‚Ä¢ –ù–µ–æ–º–µ—Ç—Ä–∏—è: –Æ–∂–∞–Ω–µ, –ê–π–≤–∞–∑–æ–≤—Å–∫–∏–π\n"
        "     ‚Ä¢ –°–µ–º—å—è: –¢—ë–ø–ª—ã–µ –∫—Ä–∞—è, –î—Ä—É–∑—å—è, –í—Å–µ –°–≤–æ–∏ VIP\n"
        "     ‚Ä¢ –¢–æ—á–Ω–æ: –í–∞—Å–∏–ª—å–µ–≤—Å–∫–∏–π –æ—Å—Ç—Ä–æ–≤, –ü–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ, –ü–∞—Ç—Ä–∏–∫–∏\n"
        "     ‚Ä¢ –°–°–ö: –î—ã—Ö–∞–Ω–∏–µ, –õ—É—á—à–∏–π, –†–∞–∫—É—Ä—Å, –°–µ–≥–æ–¥–Ω—è, –°–µ—Ä–¥—Ü–µ, –¢—Ä–∞–¥–∏—Ü–∏–∏, –§–æ–Ω—Ç–∞–Ω—ã\n"
        "     –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ñ–ö –≤—ã–¥–µ–ª—è–π –∫–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å, —Å—Ä–æ–∫–∏ —Å–¥–∞—á–∏, —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É ¬´–∫–≤–∞–¥—Ä–∞—Ç–∞¬ª –∏ —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é.\n"
        "  5. **–õ–æ–∫–∞–ª—å–Ω—ã–µ ¬´—Ñ–∏—à–∫–∏¬ª** ‚Äî –¥–æ–±–∞–≤–ª—è–π —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–π–æ–Ω–æ–≤, –±–ª–∏–∑–æ—Å—Ç—å –∫ –ø–∞—Ä–∫–∞–º, —à–∫–æ–ª–∞–º, —Ç–æ—Ä–≥–æ–≤—ã–º –≥–∞–ª–µ—Ä–µ—è–º, –∫—É–ª—å—Ç—É—Ä–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–º —Ä–∞–∑–≤—è–∑–∫–∞–º.\n"
        "  6. **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é** ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é, –≤–∏–∑–∏—Ç –Ω–∞ –æ–±—ä–µ–∫—Ç –∏–ª–∏ –ø–æ–¥–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É.\n"
        "\n"
        "üí° **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –º–æ–¥–µ–ª–∏**:\n"
        "- –ò—Å–ø–æ–ª—å–∑—É–π ¬´—è¬ª –∏ ¬´–º—ã¬ª (¬´—è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é¬ª, ¬´–º—ã —Ü–µ–Ω–∏–º –∫–∞—á–µ—Å—Ç–≤–æ¬ª), —á—Ç–æ–±—ã –∑–≤—É—á–∞—Ç—å –ª–∏—á–Ω–æ –∏ —Ç–µ–ø–ª–æ.\n"
        "- –û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ: –¥–µ–ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏.\n"
        "- –ò–∑–±–µ–≥–∞–π —Å—É—Ö–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –∏ –∞–Ω–≥–ª–∏—Ü–∏–∑–º–æ–≤, –≥–æ–≤–æ—Ä–∏ ¬´–ø–ª–æ—â–∞–¥—å –∫–≤–∞—Ä—Ç–∏—Ä—ã¬ª, ¬´—Å—Ä–æ–∫ —Å–¥–∞—á–∏¬ª, ¬´–≤—ã—Å–æ–∫–∏–µ –ø–æ—Ç–æ–ª–∫–∏¬ª.\n"
        "- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω—ã—Ö —Ü–∏—Ñ—Ä –∏–ª–∏ —Å—Ä–æ–∫–æ–≤, —á–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞–π—Å—è –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —É—Ç–æ—á–Ω–∏—Ç—å —É –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞.\n"
        "- –ü—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –ñ–ö —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –≤—ã–≥–æ–¥–∞—Ö –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è: —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ, –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ—Å—Ç—å, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.\n"
        "- –î–æ–±–∞–≤–ª—è–π –∂–∏–≤—ã–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ (¬´—É—Ç—Ä–æ–º —Å–æ–ª–Ω—Ü–µ –∑–∞–ª–∏–≤–∞–µ—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–∞–Ω–æ—Ä–∞–º–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏¬ª, ¬´—Ä—è–¥–æ–º —É—é—Ç–Ω—ã–π —Å–∫–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫¬ª).\n"
        "- –ë—É–¥—å –≥–æ—Ç–æ–≤–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã: –∏–ø–æ—Ç–µ–∫–∞, –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏, –¥–æ–≥–æ–≤–æ—Ä –¥–æ–ª–µ–≤–æ–≥–æ —É—á–∞—Å—Ç–∏—è, —Ö–æ–¥ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞.\n"
        "\n"
        "–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ —Å—É—â–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–∞, –±—É–¥—å –∏—Å–∫—Ä–µ–Ω–Ω–µ–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç‚Äë—Ä–∏–µ–ª—Ç–æ—Ä –∏–∑ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞."
    )

    def build_prompt(self, user_input: str, history: list = None, persona: str = None,
                     metadata: dict = None, add_time_context: bool = False) -> str:

        persona = persona or self.default_persona
        system_section = (
            f"{self.default_instruction}\n\n"
            f"–¢—ã –≤—ã—Å—Ç—É–ø–∞–µ—à—å –≤ —Ä–æ–ª–∏ {persona}, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ç—ã –ø–æ–¥–±–∏—Ä–∞–µ—à—å —Ç–æ–Ω –∏ —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞, "
            f"—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–æ–ª–∏. "
        )

        super_prompt_instructions = (
            "\n–ü–†–ò–ù–¶–ò–ü–´ –°–£–ü–ï–†-–ü–†–û–ú–¢–ê:\n"
            "- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–π –∑–∞–ø—É—Ç–∞–Ω–Ω—ã–µ –∏–ª–∏ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –¥–µ—Ç–∞–ª—å–Ω—ã–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.\n"
            "- –†–∞–∑–±–∏–≤–∞–π –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É –Ω–∞ —á—ë—Ç–∫–∏–µ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ —ç—Ç–∞–ø—ã.\n"
            "- –í—Å–µ–≥–¥–∞ –¥—É–º–∞–π –æ –∫–æ–Ω–µ—á–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: —Ç–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º–∏ –∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã–º–∏.\n"
            "- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∏—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Å—Ç–∞ –¥–ª—è –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–µ–π.\n"
        )
        system_section += super_prompt_instructions

        if metadata:
            meta_lines = ["–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è:"]
            for key, value in metadata.items():
                meta_lines.append(f"- {key.capitalize()}: {value}")
            metadata_section = "\n".join(meta_lines)
            system_section += f"\n{metadata_section}\n"
        else:
            system_section += "\n"

        time_context = ""
        if add_time_context:
            from datetime import datetime
            time_context = f"–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"

        history_prompt = ""
        if history:
            for idx, (user_text, assistant_text) in enumerate(history, 1):
                history_prompt += f"–î–∏–∞–ª–æ–≥ {idx}:\nUser: {user_text}\nAssistant: {assistant_text}\n\n"

        final_prompt = (
            f"{system_section}\n"
            f"{time_context}"
            f"{history_prompt}"
            "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –î–∞–≤–∞–π –∫—Ä–∞—Å–∏–≤—ã–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç, –Ω–µ –ø—Ä–µ–≤—ã—à–∞—é—â–∏–π 2-3 –∞–±–∑–∞—Ü–∞.\n"
            f"User: {user_input}\nAssistant:"
        )

        return final_prompt
