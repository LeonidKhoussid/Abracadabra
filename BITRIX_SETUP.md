# Настройка интеграции с Битрикс24

## Проблемы с интеграцией

**РЕШЕНЫ** ✅ 
- Цена теперь передается в поле `OPPORTUNITY` (сумма сделки), а не только в комментариях
- Контактные данные (имя, телефон, email) теперь корректно сохраняются в Битрикс24

## Что было исправлено

### 1. **Передача цены в поле сделки**
- Добавлено поле `OPPORTUNITY` для суммы сделки
- Добавлено поле `CURRENCY_ID` для валюты (RUB)
- Создана функция `parsePrice()` для корректного парсинга цены из строк типа "5.2 млн ₽"

### 2. **Переход с лидов на сделки с контактами**
- Изменен API endpoint с `crm.lead.add` на `crm.deal.add`
- Добавлено автоматическое создание контактов через `crm.contact.add`
- Контакты автоматически привязываются к сделкам
- Сделки лучше подходят для работы с ценами недвижимости
- Автоматически устанавливается этап "NEW" и тип "GOODS"

### 3. **Дополнительные поля недвижимости**
Добавлены пользовательские поля для сохранения данных о недвижимости:
- `UF_CRM_PROPERTY_ID` - ID объекта
- `UF_CRM_PROPERTY_TYPE` - Тип недвижимости
- `UF_CRM_PROPERTY_AREA` - Площадь
- `UF_CRM_PROPERTY_ROOMS` - Количество комнат

## Настройка пользовательских полей в Битрикс24

### Для корректной работы нужно создать пользовательские поля в CRM:

1. **Перейдите в CRM → Настройки → Пользовательские поля → Сделки**

2. **Создайте следующие поля:**

| Название | Код поля | Тип |
|----------|----------|-----|
| ID объекта недвижимости | UF_CRM_PROPERTY_ID | Число |
| Тип недвижимости | UF_CRM_PROPERTY_TYPE | Строка |
| Площадь объекта | UF_CRM_PROPERTY_AREA | Число |
| Количество комнат | UF_CRM_PROPERTY_ROOMS | Строка |

### 3. **Webhook URL**
Текущий webhook: `https://b24-bvtv4z.bitrix24.ru/rest/1/bal8wrv83oix1jg9/`

Убедитесь, что webhook имеет права на:
- `crm` - работа с CRM
- `crm.deal.add` - создание сделок
- `crm.contact.add` - создание контактов

## Как работает парсинг цены

```javascript
// Примеры парсинга:
"5.2 млн ₽" → 5200000
"от 3.5 млн ₽" → 3500000  
"1500000" → 1500000
"2,5 млн" → 2500000
```

## Структура данных сделки

```javascript
const dealData = {
  title: "Заявка с сайта: ЖК Режиссёр",
  name: "Иван Иванов",           // Имя контакта
  phone: "9183193950",           // Телефон контакта  
  email: "ivan@email.com",       // Email контакта
  opportunity: 5200000,          // Цена в рублях
  currency: "RUB",
  comments: "Детальная информация...",
  propertyId: 123,
  propertyType: "apartment",
  propertyArea: "65.5",
  propertyRooms: "2"
}
```

## Процесс создания заявки

1. **Создается контакт** с именем, телефоном и email
2. **Создается сделка** с привязкой к контакту
3. **Сохраняются данные о недвижимости** в пользовательских полях
4. **Возвращаются ID** контакта и сделки

## Отладка

Для отладки передачи цены добавлено логирование в консоль браузера:
- Исходная цена из API
- Отформатированная цена
- Распарсенная цена в рублях
- Полные данные объекта

## Проверка результата

После отправки заявки:
1. Откройте CRM → Сделки в Битрикс24
2. Найдите созданную сделку
3. Проверьте поле "Сумма" - там должна быть корректная цена
4. Проверьте пользовательские поля с данными о недвижимости

## Альтернативные варианты

Если нужно создавать лиды вместо сделок, используйте:
```javascript
await bitrixService.sendLead(leadData); // вместо sendDeal()
```

Но для недвижимости сделки предпочтительнее, так как:
- Лучше отслеживание воронки продаж
- Корректная работа с ценами
- Больше возможностей для аналитики 